# A simple template for a app with users

If you're looking to kickstart your Django application and have it up and running in a production environment within a few hours, consider forking the code from this repository. For comprehensive step-by-step guidance and additional alternatives and options, check out the accompanying blog post. It provides in-depth insights into each of the steps, helping you make the most of your Django project.

## Local installation

First clone the repository.

```
$ git clone https://github.com/nhatcher/users-template.git
```

After that create a virtual environment and install requirements

```
$ cd users-template/
$ python -m venv venv
$ source venv/bin/activate
```

Then you need to apply the migrations. This will create an sqlite3 file in `server/`.

```
(venv) $ cd server
(venv) server $ pip install -r requirements.txt
(venv) server $ python manage.py migrate
```

Create a superuser
```
(venv) $ python manage.py createsuperuser
```

## Running in a development environment

You need to have three servers running:

A proxy server:
```
$ caddy run
```

The front end:
```
frontend_test$ python -m http.server 5173
```

The django server:
```
(venv) server$ python manage.py runserver
```

That's it, you can visit now <http://localhost:2080/> and test your application locally!

## Running tests:

That will run the linter, formatter, type checker and tests

```
(venv) $ ./run_tests.sh
```

## Server provision and initial setup

With a bit of luck

```
install.sh
```

1. Setup Caddy (or a different proxy server)

Install the caddy binary in your remote computer. I will assume it is on `/opt/caddy/caddy`.

Create an underprivileged `caddy` user.
```
root@remote# groupadd --system caddy
root@remote# useradd --system --gid caddy --create-home --home-dir /var/lib/caddy --shell /usr/sbin/nologin --comment "Caddy server" caddy
```

Add it as a daemon. For instance with `systemd` this usually involves copying over the file `caddy.service` to `/etc/systemd/system/caddy.service`

Copy the `deployment_scripts/Caddyfile` to `/etc/caddy/Caddyfile`.

And then:
```
root@remote:~# systemctl start caddy
```

2. Setup gunicorn

Create an underprivileged django user:
```
root@remote# groupadd --system django
root@remote# useradd --system --gid django --create-home --home-dir /var/lib/django --shell /usr/sbin/nologin --comment "Django app runner" django
```


## Production logs and troubleshooting

1. Issues with systemd

journalctl is your friend

2. Access logs

If configured correctly caddy access logs should be at `/var/log/caddy/access.log`. A nice way to inspect those logs is [jq](https://jqlang.github.io/jq/):

```
:~# tail -f /var/log/caddy/access.log | jq .request.uri
```
3. Application logs

This are the logs generated by your application.

## Deployment

If everything has been correctly set up, deployment will be a matter of running one script.

First push the code you want to deploy to the main branch.

As root in the remote computer just run
```
root@remote:~# deploy.sh
```

That will pull the latest code, create the virtualevn, install the dependencies, make migrations if needed and copy all the files needed.

## License

Licensed under either of

* Apache License, Version 2.0 ([LICENSE-APACHE](LICENSE-APACHE) or http://www.apache.org/licenses/LICENSE-2.0)
* MIT license ([LICENSE-MIT](LICENSE-MIT) or http://opensource.org/licenses/MIT)

at your option.
